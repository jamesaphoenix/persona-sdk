---
title: Prompt Optimization
description: Optimize prompts using DSPy-inspired techniques for better AI performance
---

# Prompt Optimization

This guide covers optimizing prompts using various strategies including bootstrap sampling, compositional optimization, and ensemble methods.

## Creating a module

Before optimizing, define a module that represents your prompt:

```typescript
import { MockModule } from '@jamesaphoenix/persona-sdk';

const personaModule = new MockModule(
  'Generate a realistic persona for: '
);

// Test the module
const result = await personaModule.predict('tech startup employee');
console.log(result.output);
```

## Bootstrap optimization

Use few-shot learning with bootstrapped examples:

```typescript
import { 
  BootstrapOptimizer, 
  ExactMatch,
  createMockLanguageModel 
} from '@jamesaphoenix/persona-sdk';

// Create training data
const trainData = [
  { 
    input: 'software company', 
    output: 'Tech-savvy professional, 25-40 years old' 
  },
  { 
    input: 'healthcare startup', 
    output: 'Medical professional with tech interest' 
  }
];

// Create optimizer
const optimizer = new BootstrapOptimizer({
  maxLabeled: 5,        // Max labeled examples in prompt
  maxBootstrapped: 3,   // Max bootstrapped examples
  metric: ExactMatch,   // Evaluation metric
  teacherModel: createMockLanguageModel()
});

// Optimize
const result = await optimizer.optimize(personaModule, trainData);
console.log(`Final score: ${result.finalScore}`);
console.log(`Optimized prompt: ${result.optimizedModule.getPrompt()}`);
```

## COPRO optimization

Use compositional prompt optimization for iterative improvement:

```typescript
import { COPROOptimizer, FuzzyMatch } from '@jamesaphoenix/persona-sdk';

const teacherModel = createMockLanguageModel({
  'persona': 'Create detailed user personas',
  'optimize': 'Improve this prompt for better results'
});

const coproOptimizer = new COPROOptimizer(teacherModel, {
  breadth: 5,      // Candidates per round
  depth: 3,        // Optimization rounds
  temperature: 0.7, // Creativity level
  metric: FuzzyMatch
});

const result = await coproOptimizer.optimize(personaModule, trainData);
```

## Random search

Explore the prompt space with random variations:

```typescript
import { RandomSearchOptimizer } from '@jamesaphoenix/persona-sdk';

const randomOptimizer = new RandomSearchOptimizer({
  numCandidates: 20,     // Initial candidates
  budget: 100,           // Max evaluations
  strategy: 'mutation',  // Search strategy
  metric: FuzzyMatch
}, teacherModel);

const result = await randomOptimizer.optimize(
  personaModule, 
  trainData,
  validationData  // Optional validation set
);
```

## Search strategies

Random search supports three strategies:

### Random strategy
Generates completely random prompt variations.

### Mutation strategy
Creates variations by modifying existing prompts.

### Crossover strategy
Combines successful prompts to create new ones.

```typescript
// Choose strategy
const optimizer = new RandomSearchOptimizer({
  strategy: 'crossover', // 'random' | 'mutation' | 'crossover'
  // ... other options
});
```

## Creating ensembles

Combine multiple optimizers for robust performance:

```typescript
import { EnsembleOptimizer } from '@jamesaphoenix/persona-sdk';

// Run multiple optimizations
const results = await Promise.all([
  bootstrapOptimizer.optimize(module, trainData),
  coproOptimizer.optimize(module, trainData),
  randomOptimizer.optimize(module, trainData)
]);

// Create ensemble
const ensemble = EnsembleOptimizer.fromOptimizationResults(results, {
  votingStrategy: 'soft',  // Weighted by confidence
  aggregation: 'mean'      // How to combine scores
});

// Use ensemble
const prediction = await ensemble.predict('new input');
console.log(`Ensemble output: ${prediction.output}`);
console.log(`Confidence: ${prediction.confidence}`);
```

## Using metrics

Choose the right metric for your task:

```typescript
import { 
  ExactMatch,      // Exact string matching
  FuzzyMatch,      // Fuzzy string similarity
  PassageMatch,    // Passage relevance
  ContainsMatch,   // Substring matching
  NumericMatch,    // Numeric comparison
  createCompositeMetric 
} from '@jamesaphoenix/persona-sdk';

// Single metric
const optimizer = new BootstrapOptimizer({
  metric: FuzzyMatch
});

// Composite metric
const personaMetric = createCompositeMetric([
  { metric: FuzzyMatch, weight: 0.7 },
  { metric: ExactMatch, weight: 0.3 }
]);

const optimizer = new BootstrapOptimizer({
  metric: personaMetric
});
```

## Custom metrics

Create domain-specific metrics:

```typescript
const personaCompletenessMetric = {
  name: 'persona_completeness',
  evaluate: (example: any, prediction: any) => {
    try {
      const persona = JSON.parse(prediction.output);
      const requiredFields = ['name', 'age', 'occupation', 'sex'];
      const hasAll = requiredFields.every(f => f in persona);
      return hasAll ? 1.0 : 0.0;
    } catch {
      return 0.0;
    }
  }
};
```

## Performance tracking

Monitor optimization performance:

```typescript
import { measureOptimizationPerformance } from '@jamesaphoenix/persona-sdk';

const { result, timeMs } = await measureOptimizationPerformance(
  () => optimizer.optimize(module, trainData),
  'Bootstrap Optimization'
);

console.log(`Completed in ${timeMs}ms`);
console.log(`Final score: ${result.finalScore}`);
```

## Early stopping

Configure early stopping to save time:

```typescript
const optimizer = new RandomSearchOptimizer({
  numCandidates: 100,
  budget: 1000,
  earlyStopThreshold: 0.95,  // Stop if score >= 0.95
  patience: 10,               // Stop if no improvement for 10 rounds
  metric: ExactMatch
});
```

## Best practices

### Start with bootstrap
Bootstrap optimization is fast and effective for most use cases.

### Use appropriate metrics
Match your metric to your evaluation criteria.

### Validate with held-out data
Always test on data not used during optimization.

### Combine strategies
Use ensembles for production systems requiring robustness.

## Next steps

- [AI Features](/docs/ai-features) - Advanced AI integration
- [API Reference](/docs/api) - Complete API documentation
- [Examples](https://github.com/jamesaphoenix/persona-sdk/tree/main/examples) - Real-world examples